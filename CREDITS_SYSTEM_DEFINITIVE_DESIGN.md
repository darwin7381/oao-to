# Credits ç³»ç»Ÿæƒå¨è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**ï¼šV2.0 Definitive  
**æ—¥æœŸ**ï¼š2026-01-27  
**æ¶æ„**ï¼šç‹¬ç«‹åŒæ± æ¨¡å¼ï¼ˆIndependent Dual Poolsï¼‰  
**çŠ¶æ€**ï¼šç”Ÿäº§çº§æ ‡å‡†è®¾è®¡

---

## ğŸ¯ å­—æ®µå®šä¹‰ä¸æ•°æ®ç±»å‹

### å®è´¨å€¼å­—æ®µï¼ˆReal Valuesï¼‰- çœŸå®çš„ã€ä¼šå˜åŠ¨çš„æ•°å­—

#### Pool A - æ¯æœˆæ± ï¼ˆé‡ç½®å‹ï¼‰
```sql
-- å­˜å‚¨å­—æ®µ
monthly_used INTEGER,      -- ã€è®¡æ•°å™¨ã€‘æœ¬æœˆç´¯è®¡ä½¿ç”¨æ¬¡æ•°
monthly_reset_at INTEGER,  -- ã€æ—¶é—´æˆ³ã€‘ä¸‹æ¬¡é‡ç½®æ—¶é—´
plan_type TEXT,            -- ã€å…³è”ã€‘æ–¹æ¡ˆç±»å‹ï¼ˆfree, starter, pro, enterpriseï¼‰

-- åŠ¨æ€è·å–å­—æ®µï¼ˆé€šè¿‡ JOINï¼‰
monthly_quota = plans.monthly_credits  -- ä» plans è¡¨å®æ—¶è·å–

-- è®¡ç®—å­—æ®µï¼ˆä¸å­˜å‚¨ï¼‰
monthly_remaining = monthly_quota - monthly_used  -- æœ¬æœˆå‰©ä½™å…è´¹æ¬¡æ•°
```

**æ•°æ®ç‰¹æ€§**ï¼š
- `monthly_quota`ï¼š**ä¸å­˜å‚¨åœ¨ credits è¡¨**ï¼Œé€šè¿‡ JOIN plans è¡¨åŠ¨æ€è·å–
- `monthly_used`ï¼šæ¯æ¬¡ä½¿ç”¨ +1ï¼Œæœˆåˆå½’é›¶
- `monthly_remaining`ï¼šé€šè¿‡è®¡ç®—å¾—å‡º
- `plan_type`ï¼šå…³è”åˆ° plans è¡¨çš„ name å­—æ®µ

**æŸ¥è¯¢ç¤ºä¾‹**ï¼š
```sql
SELECT 
  c.balance,
  c.monthly_used,
  p.monthly_credits as monthly_quota,  -- åŠ¨æ€è·å–
  c.plan_type
FROM credits c
LEFT JOIN plans p ON c.plan_type = p.name
WHERE c.user_id = ?
```

**ä¼˜åŠ¿**ï¼š
- âœ… Plans ä¿®æ”¹ç«‹å³å¯¹æ‰€æœ‰ç”¨æˆ·ç”Ÿæ•ˆ
- âœ… ä¸ä¼šæ•°æ®ä¸åŒæ­¥
- âœ… å‡çº§æ–¹æ¡ˆæ—¶è‡ªåŠ¨åæ˜ æ–°é…é¢

#### Pool B - æ°¸ä¹…æ± ï¼ˆç´¯ç§¯å‹ï¼‰
```sql
balance INTEGER,           -- ã€å”¯ä¸€çœŸå®å€¼ã€‘æ°¸ä¹… credits æ€»é¢
```

**æ•°æ®ç‰¹æ€§**ï¼š
- å”¯ä¸€ä¼šè¢«æ‰£æ¬¾çš„å­—æ®µ
- è´­ä¹°ã€èµ é€ã€æ‰£æ¬¾éƒ½æ”¹å˜è¿™ä¸ªå€¼
- æ°¸ä¸é‡ç½®ï¼ˆé™¤éæ‰‹åŠ¨è°ƒæ•´ï¼‰

### æ¥æºè¿½è¸ªå­—æ®µï¼ˆTracking Onlyï¼‰- åªè®°å½•ã€ä¸æ‰£æ¬¾

```sql
purchased_balance INTEGER,     -- ã€è¿½è¸ªã€‘è´­ä¹°æ¥æºçš„éƒ¨åˆ†
bonus_balance INTEGER,         -- ã€è¿½è¸ªã€‘ç®¡ç†å‘˜/ä¿ƒé”€èµ é€ï¼ˆæœªæ¥æ·»åŠ ï¼‰
plan_bonus_balance INTEGER,    -- ã€è¿½è¸ªã€‘æ–¹æ¡ˆé¢å¤–èµ é€ï¼ˆæœªæ¥æ·»åŠ ï¼‰
```

**æ•°æ®ç‰¹æ€§**ï¼š
- **ä¸å‚ä¸æ‰£æ¬¾è®¡ç®—**
- åªåœ¨å¢åŠ  credits æ—¶ä¿®æ”¹
- ç”¨äºç»Ÿè®¡å’Œå®¡è®¡

**éªŒè¯å…¬å¼**ï¼š
```
balance <= purchased_balance + bonus_balance + plan_bonus_balance
```
ï¼ˆç”¨æˆ·æ¶ˆè´¹åï¼Œbalance ä¼šå°äºæ¥æºæ€»å’Œï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼‰

### ç»Ÿè®¡å­—æ®µï¼ˆHistory Onlyï¼‰- åªå¢ä¸å‡

```sql
total_purchased INTEGER,   -- ã€ç´¯è®¡ã€‘å†å²è´­ä¹°æ€»é¢
total_used INTEGER,        -- ã€ç´¯è®¡ã€‘å†å²ä½¿ç”¨æ€»é‡
```

**æ•°æ®ç‰¹æ€§**ï¼š
- å•è°ƒé€’å¢
- ç”¨äºé•¿æœŸç»Ÿè®¡
- ä¸å½±å“å¯ç”¨é¢åº¦è®¡ç®—

### é…ç½®å­—æ®µï¼ˆConfigï¼‰- æ–¹æ¡ˆé…ç½®

```sql
plan_type TEXT,            -- ã€é…ç½®ã€‘æ–¹æ¡ˆç±»å‹ï¼ˆfree, starter, pro, enterpriseï¼‰
overage_limit INTEGER,     -- ã€é…ç½®ã€‘è¶…é¢ä¸Šé™
overage_rate REAL,         -- ã€é…ç½®ã€‘è¶…é¢è´¹ç‡
```

---

## ğŸ“Š æ ¸å¿ƒè®¡ç®—å…¬å¼

### ç”¨æˆ·å¯ç”¨æ€»é¢
```
total_available = monthly_remaining + balance
                = (monthly_quota - monthly_used) + balance
```

### Balance çš„ç»„æˆ
```
balance = purchased_balance + bonus_balance + plan_bonus_balance - consumed
```

å…¶ä¸­ `consumed` æ˜¯ç”¨æˆ·å·²ç»ä½¿ç”¨æ‰çš„éƒ¨åˆ†ï¼ˆä¸å¯é€†ï¼‰

---

## ğŸ“‹ æ ¸å¿ƒæ¦‚å¿µå®šä¹‰

### ç‹¬ç«‹åŒæ± æ¶æ„ï¼ˆThe Two Poolsï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·çš„ Credits ç³»ç»Ÿ                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚  Pool A: æ¯æœˆæ± ï¼ˆMonthly Poolï¼‰             â”‚
â”‚  â”œâ”€ ä¼šé‡ç½®ï¼ˆæ¯æœˆ 1 å·æ¸…é›¶ï¼‰                  â”‚
â”‚  â”œâ”€ å…è´¹çš„ï¼ˆåŒ…å«åœ¨è®¢é˜…è´¹ä¸­ï¼‰                 â”‚
â”‚  â””â”€ ä¸èƒ½ç´¯ç§¯ï¼ˆç”¨ä¸å®Œå°±æ¶ˆå¤±ï¼‰                 â”‚
â”‚                                             â”‚
â”‚  Pool B: æ°¸ä¹…æ± ï¼ˆPermanent Poolï¼‰           â”‚
â”‚  â”œâ”€ ä¸é‡ç½®ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼‰                       â”‚
â”‚  â”œâ”€ ä»˜è´¹çš„/èµ é€çš„                           â”‚
â”‚  â””â”€ å¯ç´¯ç§¯ï¼ˆå¯ä»¥å­˜ç€æ…¢æ…¢ç”¨ï¼‰                 â”‚
â”‚                                             â”‚
â”‚  æ‰£æ¬¾é¡ºåºï¼šA â†’ B                            â”‚
â”‚  æ€»å¯ç”¨ = Pool A å‰©ä½™ + Pool B æ€»é¢          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ƒï¸ æ•°æ®åº“å­—æ®µå®šä¹‰

### Pool Aï¼ˆæ¯æœˆæ± ï¼‰- é—´æ¥è¿½è¸ªæ–¹å¼

```sql
-- é…ç½®å­—æ®µ
monthly_quota INTEGER DEFAULT 100,    -- æ¯æœˆé…é¢å®¹é‡ï¼ˆéšæ–¹æ¡ˆå˜åŒ–ï¼‰

-- è¿½è¸ªå­—æ®µ
monthly_used INTEGER DEFAULT 0,       -- æœ¬æœˆå·²ä½¿ç”¨æ¬¡æ•°

-- è®¡ç®—å­—æ®µï¼ˆä¸å­˜å‚¨ï¼‰
monthly_remaining = monthly_quota - monthly_used

-- é‡ç½®å­—æ®µ
monthly_reset_at INTEGER,             -- ä¸‹æ¬¡é‡ç½®æ—¶é—´ï¼ˆæœˆåˆï¼‰
```

**å…³é”®ç‰¹æ€§**ï¼š
- `monthly_quota` æ˜¯**é…ç½®å€¼**ï¼ˆFree: 100, Starter: 1000, Pro: 10000ï¼‰
- `monthly_used` æ˜¯**è®¡æ•°å™¨**ï¼ˆä½¿ç”¨æ—¶ +1ï¼Œæœˆåˆå½’é›¶ï¼‰
- å‰©ä½™é¢åº¦**é€šè¿‡è®¡ç®—å¾—å‡º**ï¼Œä¸ç›´æ¥å­˜å‚¨

### Pool Bï¼ˆæ°¸ä¹…æ± ï¼‰- å•ä¸€çœŸå®å€¼

```sql
-- å”¯ä¸€çœŸå®å€¼
balance INTEGER NOT NULL DEFAULT 0,   -- æ°¸ä¹… credits æ€»é¢

-- æ¥æºè¿½è¸ªå­—æ®µï¼ˆçº¯ç»Ÿè®¡ï¼Œä¸å‚ä¸æ‰£æ¬¾ï¼‰
purchased_balance INTEGER DEFAULT 0,     -- è´­ä¹°çš„éƒ¨åˆ†
bonus_balance INTEGER DEFAULT 0,         -- ç®¡ç†å‘˜/ä¿ƒé”€èµ é€
plan_bonus_balance INTEGER DEFAULT 0,    -- æ–¹æ¡ˆé¢å¤–èµ é€ï¼ˆå¦‚å¹´è´¹å¥–åŠ±ï¼‰

-- éªŒè¯å…¬å¼
balance = purchased_balance + bonus_balance + plan_bonus_balance
```

**å…³é”®ç‰¹æ€§**ï¼š
- `balance` æ˜¯**å”¯ä¸€è¢«æ‰£æ¬¾çš„å­—æ®µ**
- æ¥æºè¿½è¸ªå­—æ®µ**åªè®°å½•ã€ä¸æ‰£æ¬¾**
- ç®¡ç†å‘˜è°ƒæ•´ã€è´­ä¹°ã€èµ é€éƒ½æ”¹å˜ `balance`

### ç»Ÿè®¡å­—æ®µï¼ˆåªå¢ä¸å‡ï¼‰

```sql
total_purchased INTEGER DEFAULT 0,    -- ç´¯è®¡è´­ä¹°ï¼ˆå†å²æ€»å’Œï¼‰
total_used INTEGER DEFAULT 0,         -- ç´¯è®¡ä½¿ç”¨ï¼ˆå†å²æ€»å’Œï¼‰
```

### âŒ åº”åˆ é™¤çš„å†—ä½™å­—æ®µ

```sql
subscription_balance INTEGER,         -- âŒ å’Œ monthly_quota é‡å¤
```

---

## ğŸ’° æ‰£æ¬¾é€»è¾‘ï¼ˆDeduction Logicï¼‰

### æ ‡å‡†æ‰£æ¬¾æµç¨‹

```
ä½¿ç”¨ 1 æ¬¡ APIï¼ˆcost = 1ï¼‰ï¼š

Step 1: æ£€æŸ¥ Pool Aï¼ˆæ¯æœˆæ± ï¼‰
  â”œâ”€ monthly_used < monthly_quotaï¼Ÿ
  â”‚  â”œâ”€ YESï¼š
  â”‚  â”‚  â”œâ”€ monthly_used += 1
  â”‚  â”‚  â”œâ”€ total_used += 1
  â”‚  â”‚  â””â”€ balance ä¸å˜ âœ“ å…è´¹ä½¿ç”¨
  â”‚  â”‚
  â”‚  â””â”€ NOï¼šè¿›å…¥ Step 2
  
Step 2: ä½¿ç”¨ Pool Bï¼ˆæ°¸ä¹…æ± ï¼‰
  â”œâ”€ balance >= costï¼Ÿ
  â”‚  â”œâ”€ YESï¼š
  â”‚  â”‚  â”œâ”€ balance -= cost
  â”‚  â”‚  â”œâ”€ monthly_used += 1
  â”‚  â”‚  â”œâ”€ total_used += 1
  â”‚  â”‚  â””â”€ æ¥æºè¿½è¸ªå­—æ®µä¸å˜ âœ“
  â”‚  â”‚
  â”‚  â””â”€ NOï¼šæ‹’ç»æœåŠ¡ï¼ˆä½™é¢ä¸è¶³ï¼‰
```

### å…³é”®åŸåˆ™

1. âœ… **Pool A ä¼˜å…ˆ**ï¼šå…ˆç”¨å…è´¹é¢åº¦
2. âœ… **Pool B æ˜¯åå¤‡**ï¼šå…è´¹ç”¨å®Œæ‰æ‰£è¿™ä¸ª
3. âœ… **æ¥æºå­—æ®µä¸åŠ¨**ï¼š`purchased_balance` ç­‰åªè®°å½•ï¼Œä¸æ‰£æ¬¾
4. âœ… **monthly_used æ€»æ˜¯å¢åŠ **ï¼šæ— è®ºç”¨å“ªä¸ªæ± å­

---

## ğŸ“Š å„ç§åœºæ™¯å¤„ç†

### åœºæ™¯ 1ï¼šæ­£å¸¸ä½¿ç”¨

```
ç”¨æˆ·çŠ¶æ€ï¼š
  Pool A: quota 100, used 30 â†’ å‰©ä½™ 70
  Pool B: balance 500
  æ€»å¯ç”¨ï¼š70 + 500 = 570

ä½¿ç”¨ 1 æ¬¡ï¼š
  monthly_used: 30 â†’ 31
  balance: 500 â†’ 500ï¼ˆä¸å˜ï¼‰
  æ€»å¯ç”¨ï¼š570 â†’ 569
```

### åœºæ™¯ 2ï¼šPool A ç”¨å®Œ

```
ç”¨æˆ·çŠ¶æ€ï¼š
  Pool A: quota 100, used 100 â†’ å‰©ä½™ 0
  Pool B: balance 500
  æ€»å¯ç”¨ï¼š0 + 500 = 500

ä½¿ç”¨ 1 æ¬¡ï¼š
  monthly_used: 100 â†’ 101
  balance: 500 â†’ 499ï¼ˆå¼€å§‹æ‰£ï¼‰
  æ€»å¯ç”¨ï¼š500 â†’ 499
```

### åœºæ™¯ 3ï¼šæœˆåˆé‡ç½®

```
é‡ç½®å‰ï¼ˆ1/31 23:59ï¼‰ï¼š
  monthly_quota: 100
  monthly_used: 150
  balance: 450
  
é‡ç½®åï¼ˆ2/1 00:00ï¼‰ï¼š
  monthly_quota: 100ï¼ˆä¸å˜ï¼‰
  monthly_used: 0ï¼ˆå½’é›¶ï¼‰
  balance: 450ï¼ˆä¸å˜ï¼‰
  
å¯ç”¨å˜åŒ–ï¼š450 â†’ 550ï¼ˆå…è´¹é¢åº¦æ¢å¤ï¼‰
```

### åœºæ™¯ 4ï¼šæœˆä¸­å‡çº§ï¼ˆå…³é”®åœºæ™¯ï¼ï¼‰

```
1/15 ä» Free å‡çº§åˆ° Starter
å·²ç”¨ 30 æ¬¡

å‡çº§å‰ï¼š
  plan_type: 'free'
  monthly_quota: 100ï¼ˆä» plans è·å–ï¼šfree.monthly_creditsï¼‰
  monthly_used: 30
  balance: 200
  å¯ç”¨ = (100-30) + 200 = 270

å‡çº§æ“ä½œï¼š
  UPDATE credits 
  SET plan_type = 'starter'
  WHERE user_id = ?

å‡çº§åï¼ˆæŸ¥è¯¢æ—¶ï¼‰ï¼š
  plan_type: 'starter'
  monthly_quota: 1000ï¼ˆä» plans è·å–ï¼šstarter.monthly_creditsï¼‰âœ“ è‡ªåŠ¨å˜åŒ–
  monthly_used: 30ï¼ˆä¿æŒï¼‰
  balance: 200ï¼ˆä¸å˜ï¼‰
  å¯ç”¨ = (1000-30) + 200 = 1170

å˜åŒ–ï¼š270 â†’ 1170ï¼ˆå¢åŠ  900 æ¬¡å…è´¹é¢åº¦ï¼‰

å…³é”®ï¼šåªéœ€æ”¹ plan_typeï¼Œquota è‡ªåŠ¨è·Ÿéšï¼
```

### åœºæ™¯ 5ï¼šæœˆä¸­é™çº§ï¼ˆéœ€æ³¨æ„ï¼ï¼‰

```
1/15 ä» Pro é™çº§åˆ° Free
å·²ç”¨ 150 æ¬¡

é™çº§å‰ï¼š
  plan_type: 'pro'
  monthly_quota: 10000ï¼ˆä» plans è·å–ï¼‰
  monthly_used: 150
  balance: 200
  å¯ç”¨ = (10000-150) + 200 = 10050

é™çº§æ“ä½œï¼š
  UPDATE credits 
  SET plan_type = 'free'

é™çº§åï¼ˆæŸ¥è¯¢æ—¶ï¼‰ï¼š
  plan_type: 'free'
  monthly_quota: 100ï¼ˆä» plans è·å–ï¼šfree.monthly_creditsï¼‰âœ“ è‡ªåŠ¨å˜åŒ–
  monthly_used: 150ï¼ˆä¿æŒï¼‰
  balance: 200ï¼ˆä¸å˜ï¼‰
  å¯ç”¨ = max(0, 100-150) + 200 = 0 + 200 = 200

æ³¨æ„ï¼šmonthly_used (150) > monthly_quota (100)
åç»­ä½¿ç”¨ç›´æ¥æ‰£ balanceï¼ˆå› ä¸ºå…è´¹é¢åº¦å·²é€æ”¯ï¼‰
```

### åœºæ™¯ 6ï¼šå¹´åº¦è®¢é˜…ï¼ˆç‰¹æ®Šèµ é€ï¼‰

```
ç”¨æˆ·è®¢é˜… Pro å¹´ä»˜ï¼ˆ$299/å¹´ï¼‰

ç«‹å³ç”Ÿæ•ˆï¼š
  plan_type: 'pro'
  monthly_quota: 10000ï¼ˆä» plans.pro.monthly_credits è·å–ï¼‰
  plan_bonus_balance: +12000ï¼ˆå¹´è´¹ä¸€æ¬¡æ€§èµ é€ï¼‰
  balance: +12000
  
æ¯ä¸ªæœˆï¼š
  monthly_used é‡ç½®ä¸º 0
  monthly_quota: 10000ï¼ˆä» plans åŠ¨æ€è·å–ï¼Œä¿æŒä¸å˜ï¼‰
  plan_bonus_balance ä¸å˜ï¼ˆä¸€ç›´ä¿ç•™ï¼‰
  
å¦‚æœä¸­é€”å–æ¶ˆè®¢é˜…ï¼š
  plan_type: 'pro' â†’ 'free'
  monthly_quota: 10000 â†’ 100ï¼ˆè‡ªåŠ¨è·Ÿéš plan_typeï¼‰
  balance ä¿æŒï¼ˆå·²ç»™çš„ä¸æ”¶å›ï¼‰
```

### åœºæ™¯ 7ï¼šè´­ä¹° Credits

```
ç”¨æˆ·è´­ä¹° 1000 creditsï¼ˆ$10ï¼‰

æ“ä½œï¼š
  purchased_balance: +1000
  balance: +1000
  total_purchased: +1000
  
è®°å½•äº¤æ˜“ï¼š
  type: 'purchase'
  amount: +1000
  balance_after: æ–°çš„ balance
```

### åœºæ™¯ 8ï¼šç®¡ç†å‘˜è°ƒæ•´

```
ç®¡ç†å‘˜èµ é€ 500 creditsï¼š
  bonus_balance: +500
  balance: +500
  # purchased_balance ä¸å˜ï¼ˆå› ä¸ºä¸æ˜¯è´­ä¹°çš„ï¼‰
  
ç®¡ç†å‘˜æ‰£é™¤ 200ï¼ˆå¤„ç½šï¼‰ï¼š
  balance: -200
  # æ¥æºå­—æ®µä¸å˜ï¼ˆåªæ˜¯æ€»é¢å‡å°‘ï¼‰
  
æ³¨æ„ï¼šbalance å¯èƒ½å°äº purchased_balance + bonus_balance
è¿™æ˜¯æ­£å¸¸çš„ï¼ˆç”¨æˆ·å¯èƒ½å·²ç»æ¶ˆè´¹äº†éƒ¨åˆ†ï¼‰
```

---

## ğŸ¯ å…³é”®æ•°å­¦å…¬å¼

### æ ¸å¿ƒå…¬å¼

```
æ€»å¯ç”¨æ¬¡æ•° = Pool A å‰©ä½™ + Pool B æ€»é¢
          = (monthly_quota - monthly_used) + balance
          
å…¶ä¸­ï¼š
  monthly_quotaï¼šå½“å‰æ–¹æ¡ˆé…é¢ï¼ˆé…ç½®ï¼‰
  monthly_usedï¼šæœ¬æœˆä½¿ç”¨è®¡æ•°ï¼ˆè¿½è¸ªï¼‰
  balanceï¼šæ°¸ä¹… creditsï¼ˆå”¯ä¸€çœŸå®å€¼ï¼‰
```

### éªŒè¯å…¬å¼ï¼ˆæ•°æ®ä¸€è‡´æ€§æ£€æŸ¥ï¼‰

```
# Pool B çš„æ¥æºè¿½è¸ªéªŒè¯
balance >= purchased_balance + bonus_balance + plan_bonus_balance

# æ³¨æ„ï¼šä¸æ˜¯ç­‰å·ï¼å› ä¸ºç”¨æˆ·å¯èƒ½å·²ç»æ¶ˆè´¹äº†éƒ¨åˆ†
# ä½†åˆå§‹åŒ–ååº”è¯¥ç›¸ç­‰ï¼Œä½¿ç”¨å balance ä¼šå°äºæ¥æºæ€»å’Œ
```

### æœˆåº¦é‡ç½®å…¬å¼

```
é‡ç½®å‰å¯ç”¨ = (quota - used) + balance
é‡ç½®åå¯ç”¨ = quota + balance

å˜åŒ– = quota - usedï¼ˆæ¢å¤çš„å…è´¹é¢åº¦ï¼‰
```

---

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### æ¯æ—¥ä»»åŠ¡ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰

æ— ç‰¹æ®Šå¤„ç†

### æ¯æœˆä»»åŠ¡ï¼ˆé‡è¦ï¼ï¼‰

```
Cron Job: æ¯æœˆ 1 å· 00:00 UTC

å¯¹æ‰€æœ‰ç”¨æˆ·æ‰§è¡Œï¼š
  UPDATE credits 
  SET 
    monthly_used = 0,
    monthly_reset_at = [ä¸‹ä¸ªæœˆ 1 å·],
    updated_at = NOW()
  WHERE 1=1;
  
æ³¨æ„ï¼š
  - monthly_quota ä¸å˜ï¼ˆé™¤éæ–¹æ¡ˆæœ‰å˜æ›´ï¼‰
  - balance ä¸å˜
  - æ‰€æœ‰æ¥æºè¿½è¸ªå­—æ®µä¸å˜
```

### æ–¹æ¡ˆå˜æ›´å¤„ç†

```
å‡çº§/é™çº§æ—¶ï¼š
  UPDATE credits
  SET
    monthly_quota = [æ–°æ–¹æ¡ˆé…é¢],
    plan_type = [æ–°æ–¹æ¡ˆç±»å‹],
    updated_at = NOW()
  WHERE user_id = ?;
  
å¦‚æœæœ‰æ–¹æ¡ˆèµ é€ï¼š
  UPDATE credits
  SET
    plan_bonus_balance = plan_bonus_balance + [èµ é€é¢åº¦],
    balance = balance + [èµ é€é¢åº¦],
    updated_at = NOW()
  WHERE user_id = ?;
```

---

## ğŸ“± å‰ç«¯æ˜¾ç¤ºè§„èŒƒ

### ä¸»è¦æ˜¾ç¤ºï¼ˆCredits é¡µé¢å¤§å¡ç‰‡ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’³ Available Credits          â”‚
â”‚                                â”‚
â”‚       198                      â”‚  â† total_available
â”‚                                â”‚
â”‚  æœ¬æœˆå…è´¹é¢åº¦ï¼š98 / 100        â”‚  â† Pool A
â”‚  ä»˜è´¹ä½™é¢ï¼š100 credits         â”‚  â† Pool B
â”‚                                â”‚
â”‚  [Top Up Credits]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¯¦ç»†åˆ†è§£ï¼ˆå¯é€‰å±•å¼€ï¼‰

```
è¯¦ç»†ä½™é¢ï¼š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æœ¬æœˆå…è´¹é¢åº¦
  å·²ä½¿ç”¨ï¼š2 / 100
  å‰©ä½™ï¼š98 æ¬¡
  é‡ç½®ï¼š2026-02-01
  
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’° æ°¸ä¹…ä½™é¢
  è´­ä¹°çš„ï¼š500 credits
  èµ é€çš„ï¼š100 credits
  å¹´è´¹å¥–åŠ±ï¼š500 credits
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  å°è®¡ï¼š1,100 credits
  
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ¨ æ€»è®¡å¯ç”¨
  å…è´¹æ¬¡æ•°ï¼š98
  ä»˜è´¹é¢åº¦ï¼š1,100
  åˆè®¡ï¼š1,198 æ¬¡
```

### äº¤æ˜“è®°å½•æ˜¾ç¤º

```
Recent Transactions:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
2026-01-27 20:15  Create short link   -1
  ä½¿ç”¨æœˆé…é¢ï¼ˆ2/100ï¼‰
  ä½™é¢ï¼š100 â†’ 100 âœ“

2026-01-27 19:30  Purchased credits   +500
  è´­ä¹° 500 credits
  ä½™é¢ï¼š100 â†’ 600 â†‘
```

---

## ğŸ¯ å„æ–¹æ¡ˆé…ç½®ç¤ºä¾‹

### Free Plan
```
monthly_quota: 100
plan_bonus_balance: 0
ç”¨æˆ·è´­ä¹°: 0ï¼ˆåˆå§‹ï¼‰
ç®¡ç†å‘˜èµ é€: 100ï¼ˆæ¬¢è¿å¥–åŠ±ï¼‰

åˆå§‹å¯ç”¨ = 100 + 100 = 200
```

### Starter Plan ($9/æœˆ)
```
monthly_quota: 1000
plan_bonus_balance: 0
å‡çº§å¥–åŠ±: +200ï¼ˆä¸€æ¬¡æ€§ï¼‰

å¯ç”¨ = 1000 + ä¹‹å‰çš„ balance + 200
```

### Pro Plan ($29/æœˆ)
```
monthly_quota: 10000
plan_bonus_balance: 0
å‡çº§å¥–åŠ±: +500ï¼ˆä¸€æ¬¡æ€§ï¼‰

å¯ç”¨ = 10000 + ä¹‹å‰çš„ balance + 500
```

### Pro Plan å¹´ä»˜ ($299/å¹´ï¼Œçœ $49ï¼‰
```
monthly_quota: 10000ï¼ˆæ¯æœˆï¼‰
plan_bonus_balance: +12000ï¼ˆå¹´è´¹ä¸€æ¬¡æ€§èµ é€ï¼‰

ç¬¬ä¸€ä¸ªæœˆå¯ç”¨ = 10000 + ä¹‹å‰çš„ balance + 12000
åç»­æ¯æœˆ = 10000 + balanceï¼ˆplan_bonus ä¼šä¸€ç›´ä¿ç•™ï¼‰
```

---

## ğŸ“… å®Œæ•´ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹

### ç”¨æˆ· A çš„ä¸€å¹´å†ç¨‹

#### 2026-01-01ï¼šæ³¨å†Œï¼ˆFree Planï¼‰
```
åˆå§‹åŒ–ï¼š
  monthly_quota: 100
  monthly_used: 0
  balance: 0
  bonus_balance: 100ï¼ˆæ³¨å†Œèµ é€ï¼‰
  
å¯ç”¨ï¼š100 + 100 = 200
```

#### 2026-01-15ï¼šä½¿ç”¨äº† 50 æ¬¡
```
æ‰£æ¬¾ï¼š
  monthly_used: 0 â†’ 50
  balance: 100 â†’ 100ï¼ˆä¸å˜ï¼Œå› ä¸ºåœ¨å…è´¹é¢åº¦å†…ï¼‰
  
å¯ç”¨ï¼š(100-50) + 100 = 150
```

#### 2026-01-20ï¼šå‡çº§åˆ° Starter
```
å‡çº§æ“ä½œï¼š
  monthly_quota: 100 â†’ 1000
  monthly_used: 50ï¼ˆä¿æŒï¼‰
  plan_bonus_balance: 0 â†’ 200ï¼ˆå‡çº§èµ é€ï¼‰
  balance: 100 â†’ 300
  
å¯ç”¨ï¼š(1000-50) + 300 = 1250
```

#### 2026-02-01ï¼šæœˆåº¦é‡ç½®
```
é‡ç½®æ“ä½œï¼š
  monthly_used: 50 â†’ 0
  monthly_quota: 1000ï¼ˆä¸å˜ï¼‰
  balance: 300ï¼ˆä¸å˜ï¼‰
  
å¯ç”¨ï¼š1000 + 300 = 1300
```

#### 2026-02-15ï¼šç”¨å®Œå…è´¹é¢åº¦ï¼ˆç”¨äº† 1100 æ¬¡ï¼‰
```
æ‰£æ¬¾ï¼š
  monthly_used: 0 â†’ 1100
  balance: 300 â†’ 200ï¼ˆè¶…è¿‡ quota åæ‰£äº† 100ï¼‰
  
è¯¦ç»†ï¼š
  - å‰ 1000 æ¬¡ï¼šå…è´¹ï¼ˆmonthly_used 1â†’1000ï¼‰
  - å 100 æ¬¡ï¼šæ‰£ balanceï¼ˆbalance 300â†’200ï¼‰
  
å¯ç”¨ï¼š0 + 200 = 200
```

#### 2026-06-15ï¼šå‡çº§åˆ° Pro å¹´ä»˜
```
å‡çº§æ“ä½œï¼š
  monthly_quota: 1000 â†’ 10000
  plan_bonus_balance: 200 â†’ 12200ï¼ˆå¹´è´¹é€ 12000ï¼‰
  balance: 150 â†’ 12150
  
å½“æœˆå¯ç”¨ï¼š(10000-å½“æœˆå·²ç”¨) + 12150
```

#### 2027-01-01ï¼šå¹´åº¦ç»­è®¢
```
ç»­è®¢æ“ä½œï¼š
  monthly_quota: 10000ï¼ˆä¿æŒï¼‰
  plan_bonus_balance: 12200 â†’ 24200ï¼ˆå†é€ 12000ï¼‰
  balance: 5000 â†’ 17000
  
å¯ç”¨ï¼š10000 + 17000 = 27000
```

#### 2027-06-30ï¼šå–æ¶ˆè®¢é˜…ï¼ˆé™ä¸º Freeï¼‰
```
é™çº§æ“ä½œï¼š
  monthly_quota: 10000 â†’ 100
  monthly_used: 5000ï¼ˆä¿æŒï¼Œè¶…è¿‡æ–° quotaï¼‰
  balance: 15000ï¼ˆä¿æŒï¼Œå·²ç»™çš„ä¸æ”¶å›ï¼‰
  plan_bonus_balance: 24200ï¼ˆä¿æŒï¼Œä½œä¸ºå†å²è®°å½•ï¼‰
  
å¯ç”¨ï¼š0ï¼ˆå·²è¶… quotaï¼‰+ 15000 = 15000
åç»­ä½¿ç”¨ç›´æ¥æ‰£ balance
```

---

## ğŸ”§ å…³é”®æ“ä½œçš„å®ç°

### 1. è´­ä¹° Credits

```
ç”¨æˆ·è´­ä¹° 500 creditsï¼ˆ$5ï¼‰

æ“ä½œï¼š
  purchased_balance: +500
  balance: +500
  total_purchased: +500
  
è®°å½•äº¤æ˜“ï¼š
  type: 'purchase'
  amount: +500
  balance_after: [æ–° balance]
  description: 'è´­ä¹° 500 credits'
```

### 2. ç®¡ç†å‘˜è°ƒæ•´

```
ç®¡ç†å‘˜èµ é€ 200 creditsï¼š
  bonus_balance: +200
  balance: +200
  # purchased_balance ä¸å˜
  
è®°å½•äº¤æ˜“ï¼š
  type: 'bonus'
  amount: +200
  admin_id: [ç®¡ç†å‘˜ ID]
  description: 'ç®¡ç†å‘˜æ‰‹åŠ¨è°ƒæ•´'
```

### 3. å‡çº§æ–¹æ¡ˆ

```
ä» Free å‡çº§åˆ° Proï¼š

Step 1: æ›´æ–°æ–¹æ¡ˆç±»å‹ï¼ˆquota è‡ªåŠ¨è·Ÿéšï¼‰
  UPDATE credits 
  SET plan_type = 'pro'
  WHERE user_id = ?
  
  ç»“æœï¼š
    plan_type: 'free' â†’ 'pro'
    monthly_quota: 100 â†’ 10000ï¼ˆé€šè¿‡ JOIN è‡ªåŠ¨å˜åŒ–ï¼‰
  
Step 2: èµ é€å‡çº§å¥–åŠ±ï¼ˆå¦‚æœæœ‰ï¼‰
  UPDATE credits
  SET 
    plan_bonus_balance = plan_bonus_balance + 500,
    balance = balance + 500
  
è®°å½•äº¤æ˜“ï¼š
  type: 'bonus'
  amount: +500
  description: 'Pro plan å‡çº§å¥–åŠ±'
```

### 4. é™çº§æ–¹æ¡ˆ

```
ä» Pro é™çº§åˆ° Freeï¼š

Step 1: æ›´æ–°æ–¹æ¡ˆç±»å‹
  UPDATE credits 
  SET plan_type = 'free'
  
  ç»“æœï¼š
    plan_type: 'pro' â†’ 'free'
    monthly_quota: 10000 â†’ 100ï¼ˆé€šè¿‡ JOIN è‡ªåŠ¨å˜åŒ–ï¼‰
  
Step 2: å¤„ç† plan_bonusï¼ˆå¯é€‰ï¼‰
  é€‰é¡¹ Aï¼šä¿ç•™ï¼ˆå·²ç»™çš„ä¸æ”¶å›ï¼‰æ¨è âœ“
  é€‰é¡¹ Bï¼šæ¸…é›¶å¹¶è®°å½•è´Ÿäº¤æ˜“
```

---

## ğŸ¨ ç”¨æˆ·ä½“éªŒè®¾è®¡

### ä¸åŒæ–¹æ¡ˆçš„ç”¨æˆ·çœ‹åˆ°çš„

#### Free Plan ç”¨æˆ·
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯ç”¨ Credits: 150           â”‚
â”‚                             â”‚
â”‚ ğŸ“Š æœ¬æœˆå…è´¹é¢åº¦             â”‚
â”‚   å·²ä½¿ç”¨ï¼š25 / 100          â”‚
â”‚   è¿›åº¦æ¡ï¼šâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 25%   â”‚
â”‚                             â”‚
â”‚ ğŸ’ ä»˜è´¹ä½™é¢                 â”‚
â”‚   è´­ä¹°çš„ï¼š0                 â”‚
â”‚   èµ é€çš„ï¼š100               â”‚
â”‚   å°è®¡ï¼š100 credits         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»ç»“ï¼šæœ¬æœˆè¿˜æœ‰ 75 æ¬¡å…è´¹ï¼Œç”¨å®Œåä¼šæ‰£ä»˜è´¹ä½™é¢
```

#### Pro Plan ç”¨æˆ·
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¯ç”¨ Credits: 18,500        â”‚
â”‚                             â”‚
â”‚ ğŸ“Š æœ¬æœˆå…è´¹é¢åº¦             â”‚
â”‚   å·²ä½¿ç”¨ï¼š1,500 / 10,000    â”‚
â”‚   è¿›åº¦æ¡ï¼šâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘ 15%   â”‚
â”‚                             â”‚
â”‚ ğŸ’ ä»˜è´¹ä½™é¢                 â”‚
â”‚   è´­ä¹°çš„ï¼š2,000             â”‚
â”‚   å¹´è´¹èµ é€ï¼š12,000          â”‚
â”‚   å…¶ä»–èµ é€ï¼š100             â”‚
â”‚   å°è®¡ï¼š14,100 credits      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æç¤ºï¼šæœ¬æœˆå…è´¹é¢åº¦å……è¶³ï¼Œä»˜è´¹ä½™é¢ç”¨äºè¶…é¢ä½¿ç”¨
```

---

## âš ï¸ å½“å‰ç³»ç»Ÿçš„é—®é¢˜ä¸ä¿®å¤

### é—®é¢˜ 1ï¼š`subscription_balance` å†—ä½™
```
å½“å‰ï¼š
  monthly_quota: 100
  monthly_used: 2
  subscription_balance: 0      â† é‡å¤ä¸”æ— ç”¨

ä¿®å¤ï¼šåˆ é™¤ subscription_balance å­—æ®µ
```

### é—®é¢˜ 2ï¼š`purchased_balance` æ‰£æ¬¾é”™è¯¯
```
å½“å‰æ‰£æ¬¾é€»è¾‘ï¼ˆé”™è¯¯ï¼‰ï¼š
  balance -= 1
  purchased_balance -= 1       â† é”™è¯¯ï¼

æ­£ç¡®é€»è¾‘ï¼š
  balance -= 1
  # purchased_balance ä¸å˜ï¼ˆåªè¿½è¸ªæ¥æºï¼‰
```

### é—®é¢˜ 3ï¼šåˆå§‹åŒ–åˆ†ç±»é”™è¯¯
```
å½“å‰åˆå§‹åŒ–ï¼ˆæ··ä¹±ï¼‰ï¼š
  balance: 100
  purchased_balance: 100       â† é”™ï¼è¿™æ˜¯èµ é€çš„
  
æ­£ç¡®åˆå§‹åŒ–ï¼š
  balance: 100
  purchased_balance: 0
  bonus_balance: 100           â† æ³¨å†Œèµ é€
```

### é—®é¢˜ 4ï¼šå‰ç«¯æ˜¾ç¤ºå…¬å¼é”™è¯¯
```
å½“å‰æ˜¾ç¤ºï¼š
  Total Balance: 100
  
æ­£ç¡®æ˜¾ç¤ºï¼š
  Available Credits: 198
  = (100-2) + 100
  = monthly_remaining + balance
```

---

## ğŸ“ æ•°æ®ä¸€è‡´æ€§æ ¡éªŒ

### è¿è¡Œæ—¶æ ¡éªŒ

```sql
-- æ£€æŸ¥ balance çš„æ¥æºæ€»å’Œ
SELECT 
  user_id,
  balance,
  purchased_balance + bonus_balance + plan_bonus_balance as sources_sum,
  balance - (purchased_balance + bonus_balance + plan_bonus_balance) as consumed
FROM credits
WHERE balance < purchased_balance + bonus_balance + plan_bonus_balance;

-- å¦‚æœ consumed < 0ï¼Œè¯´æ˜æ•°æ®é”™è¯¯
-- å¦‚æœ consumed >= 0ï¼Œè¯´æ˜ç”¨æˆ·å·²æ¶ˆè´¹éƒ¨åˆ†ï¼ˆæ­£å¸¸ï¼‰
```

### æœˆåº¦å¯¹è´¦

```sql
-- æ£€æŸ¥ total_used æ˜¯å¦æ­£ç¡®
SELECT 
  user_id,
  total_used,
  (SELECT SUM(ABS(amount)) FROM credit_transactions 
   WHERE user_id = credits.user_id AND amount < 0) as calculated_used
FROM credits
WHERE total_used != calculated_used;
```

---

## ğŸš€ æœ€ä½³å®è·µ

### åŸåˆ™ 1ï¼šå•ä¸€çœŸå®å€¼
- âœ… `balance` æ˜¯å”¯ä¸€è¢«æ‰£æ¬¾çš„å­—æ®µ
- âœ… å…¶ä»–éƒ½æ˜¯è¿½è¸ªæˆ–é…ç½®

### åŸåˆ™ 2ï¼šæ¥æºåˆ†ç¦»
- âœ… `purchased_balance`ï¼šè´­ä¹°çš„
- âœ… `bonus_balance`ï¼šèµ é€çš„
- âœ… `plan_bonus_balance`ï¼šæ–¹æ¡ˆèµ é€
- âœ… å®ƒä»¬åªè¿½è¸ªæ¥æºï¼Œä¸å‚ä¸æ‰£æ¬¾è®¡ç®—

### åŸåˆ™ 3ï¼šé€æ˜å±•ç¤º
- âœ… ç”¨æˆ·åº”è¯¥çœ‹åˆ°æ€»å¯ç”¨ = å…è´¹ + ä»˜è´¹
- âœ… æ¸…æ¥šæ˜¾ç¤ºå„éƒ¨åˆ†çš„æ¥æº

### åŸåˆ™ 4ï¼šä¼˜é›…é™çº§
- âœ… é™çº§ä¸æ”¶å›å·²ç»™çš„ credits
- âœ… é™çº§åå·²ç”¨é‡å¯èƒ½è¶…è¿‡æ–° quotaï¼ˆæ­£å¸¸ï¼‰

---

## ğŸ“ æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ | ç¤ºä¾‹ |
|------|------|------|
| **Pool A** | æ¯æœˆæ± ï¼Œä¼šé‡ç½®çš„å…è´¹é¢åº¦ | 100 æ¬¡/æœˆ |
| **Pool B** | æ°¸ä¹…æ± ï¼Œä¸é‡ç½®çš„ credits | 500 credits |
| **monthly_quota** | Pool A çš„å®¹é‡é…ç½® | Free: 100 |
| **monthly_used** | Pool A çš„ä½¿ç”¨è®¡æ•°å™¨ | å·²ç”¨ 25 æ¬¡ |
| **monthly_remaining** | Pool A å‰©ä½™ï¼ˆè®¡ç®—å€¼ï¼‰ | 100-25=75 |
| **balance** | Pool B çš„å”¯ä¸€çœŸå®å€¼ | 500 credits |
| **purchased_balance** | Pool B æ¥æºè¿½è¸ªï¼šè´­ä¹°çš„ | 300 credits |
| **bonus_balance** | Pool B æ¥æºè¿½è¸ªï¼šèµ é€çš„ | 100 credits |
| **plan_bonus_balance** | Pool B æ¥æºè¿½è¸ªï¼šæ–¹æ¡ˆèµ é€ | 100 credits |
| **total_available** | æ€»å¯ç”¨ï¼ˆç”¨æˆ·çœ‹åˆ°çš„ï¼‰ | 75 + 500 = 575 |

---

## âš¡ å¿«é€Ÿå‚è€ƒ

### åˆ¤æ–­æµç¨‹å›¾

```
ç”¨æˆ·è¯·æ±‚ä½¿ç”¨ 1 æ¬¡ API
    â†“
monthly_used < monthly_quotaï¼Ÿ
    â†“              â†“
   YES            NO
    â†“              â†“
æœˆé…é¢-1      balance >= 1ï¼Ÿ
monthly_used++      â†“         â†“
    â†“             YES        NO
   æˆåŠŸ            â†“          â†“
              balance-1    æ‹’ç»
              monthly_used++
                  â†“
                 æˆåŠŸ
```

### æœˆåº¦é‡ç½®æµç¨‹

```
æ¯æœˆ 1 å· 00:00 UTC
    â†“
monthly_used = 0
monthly_reset_at = ä¸‹æœˆ 1 å·
    â†“
å…è´¹é¢åº¦æ¢å¤
ç”¨æˆ·å¯ç”¨æ¬¡æ•°å¢åŠ 
    â†“
å®Œæˆ
```

---

## ğŸ”’ æ•°æ®å®Œæ•´æ€§ä¿è¯

### ä¸å˜é‡ï¼ˆInvariantsï¼‰

1. `balance >= 0`ï¼ˆä½™é¢ä¸èƒ½ä¸ºè´Ÿï¼‰
2. `monthly_used >= 0`ï¼ˆä½¿ç”¨é‡ä¸èƒ½ä¸ºè´Ÿï¼‰
3. `balance <= purchased_balance + bonus_balance + plan_bonus_balance`ï¼ˆå·²æ¶ˆè´¹çš„ä¸ä¼šæ¢å¤ï¼‰
4. `total_used >= monthly_used`ï¼ˆç´¯è®¡ >= æœ¬æœˆï¼‰
5. `total_purchased >= purchased_balance`ï¼ˆç´¯è®¡ >= å½“å‰ï¼‰

### è¾¹ç•Œæ¡ä»¶

1. **é™çº§å monthly_used > monthly_quota**
   - å…è®¸çš„ï¼ˆåˆæ³•çŠ¶æ€ï¼‰
   - åç»­ä½¿ç”¨ç›´æ¥æ‰£ balance

2. **balance < æ¥æºæ€»å’Œ**
   - æ­£å¸¸çš„ï¼ˆç”¨æˆ·å·²æ¶ˆè´¹ï¼‰
   - consumed = æ¥æºæ€»å’Œ - balance

3. **å…è´¹é¢åº¦ç”¨å®Œä½† balance = 0**
   - æ‹’ç»æœåŠ¡
   - æç¤ºè´­ä¹° credits

---

## âœ… è®¾è®¡æ£€æŸ¥æ¸…å•

- [ ] Pool A å’Œ Pool B æ¦‚å¿µæ¸…æ™°åˆ†ç¦»
- [ ] æ²¡æœ‰é‡å¤è¿½è¸ªåŒä¸€ä¸ªæ± å­çš„å­—æ®µ
- [ ] æ‰£æ¬¾é€»è¾‘ï¼šå…ˆ A å B
- [ ] æ¥æºè¿½è¸ªå­—æ®µä¸å‚ä¸æ‰£æ¬¾
- [ ] å‰ç«¯æ˜¾ç¤ºæ€»å¯ç”¨ = A + B
- [ ] æœˆåº¦é‡ç½®åªé‡ç½® Pool A
- [ ] å‡çº§/é™çº§é€»è¾‘æ¸…æ™°
- [ ] å¹´åº¦æ–¹æ¡ˆå¤„ç†æ­£ç¡®
- [ ] æ•°æ®ä¸€è‡´æ€§å¯éªŒè¯

---

## ğŸ¯ æ€»ç»“

**ç‹¬ç«‹åŒæ± æ¨¡å¼**æ˜¯æ¸…æ™°ã€æ ‡å‡†ã€æ˜“ç»´æŠ¤çš„æ¶æ„ã€‚

**æ ¸å¿ƒè®°å¿†ç‚¹**ï¼š
1. Pool Aï¼šæ¯æœˆå…è´¹æ¬¡æ•°ï¼ˆquota - usedï¼‰
2. Pool Bï¼šæ°¸ä¹… creditsï¼ˆbalanceï¼‰
3. æ€»å¯ç”¨ = A + B
4. æ¥æºå­—æ®µåªè¿½è¸ªï¼Œä¸æ‰£æ¬¾
5. æ‰£æ¬¾åªæ”¹ `balance`ï¼Œå…¶ä»–å­—æ®µåªåœ¨å¢åŠ æ—¶æ”¹

**è¿™æ˜¯ç”Ÿäº§çº§çš„æ ‡å‡†è®¾è®¡ï¼**
