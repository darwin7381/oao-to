# KV + D1 é›™å¯«ç­–ç•¥æ·±åº¦åˆ†æ

**æ—¥æœŸ**: 2026-01-24  
**ç‰ˆæœ¬**: 1.0  
**ç‹€æ…‹**: æ­£è¦æ¶æ§‹è¨­è¨ˆæ–‡æª”

---

## ğŸ¯ æ ¸å¿ƒå•é¡Œ

**ç‚ºä»€éº¼è¦åŒæ™‚å¯«å…¥ KV å’Œ D1ï¼Ÿé€™ä¸æ˜¯è³‡æ–™å†—ä½™å—ï¼Ÿ**

---

## ğŸ“Š å®Œæ•´æŠ€è¡“åˆ†æ

### **KV å’Œ D1 çš„æœ¬è³ªå·®ç•°**

| ç‰¹æ€§ | Workers KV | D1 Database |
|------|-----------|-------------|
| **æ•¸æ“šçµæ§‹** | Key-Valueï¼ˆNoSQLï¼‰| é—œè¯å¼ï¼ˆSQLï¼‰|
| **æŸ¥è©¢æ–¹å¼** | åªèƒ½æŒ‰ Key æŸ¥è©¢ | æ”¯æ´è¤‡é›œ SQL |
| **è®€å–é€Ÿåº¦** | < 1msï¼ˆé‚Šç·£å¿«å–ï¼‰| 5-50msï¼ˆéœ€æŸ¥è©¢ï¼‰|
| **å¯«å…¥é€Ÿåº¦** | < 5ms | 10-100ms |
| **JOIN æ”¯æ´** | âŒ ä¸æ”¯æ´ | âœ… æ”¯æ´ |
| **WHERE æŸ¥è©¢** | âŒ ä¸æ”¯æ´ | âœ… æ”¯æ´ |
| **é©ç”¨å ´æ™¯** | å¿«é€Ÿé»æŸ¥è©¢ | è¤‡é›œæ¥­å‹™æŸ¥è©¢ |

---

## ğŸ” ç‚ºä»€éº¼é›™å¯«æ˜¯å¿…è¦çš„ï¼Ÿ

### **å ´æ™¯åˆ†æ**

#### **å ´æ™¯ 1: çŸ­ç¶²å€é‡å®šå‘** âš¡

**éœ€æ±‚**: æ¥µè‡´å¿«é€Ÿï¼ˆ< 5msï¼‰

**åªèƒ½ç”¨ KV**ï¼š
```typescript
// Core Worker
const link = await env.LINKS.get(`link:${slug}`);  // < 1ms
return c.redirect(link.url, 301);
```

**å¦‚æœåªç”¨ D1**ï¼š
```typescript
// âŒ å¤ªæ…¢
const link = await env.DB.prepare(
  'SELECT url FROM links WHERE slug = ?'
).bind(slug).first();  // 10-50ms

// å»¶é²å¢åŠ  10-50 å€ï¼
```

**çµè«–**: é‡å®šå‘å¿…é ˆç”¨ KV âœ…

---

#### **å ´æ™¯ 2: åˆ—å‡ºç”¨æˆ¶çš„æ‰€æœ‰é€£çµ** ğŸ“‹

**éœ€æ±‚**: æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„æ‰€æœ‰é€£çµ

**åªèƒ½ç”¨ D1**ï¼š
```sql
SELECT slug, url, title, created_at 
FROM links 
WHERE user_id = '89a982be-98e9-456c-bf59-55da3bfbb380'
ORDER BY created_at DESC
```

**å¦‚æœåªç”¨ KV**ï¼š
```typescript
// âŒ ä¸å¯èƒ½ï¼KV ä¸æ”¯æ´ WHERE æŸ¥è©¢
// å”¯ä¸€æ–¹æ³•ï¼šæƒææ‰€æœ‰ linksï¼Œé€å€‹éæ¿¾
const list = await env.LINKS.list({ prefix: 'link:' });  // ç²å–æ‰€æœ‰
for (const key of list.keys) {
  const link = await env.LINKS.get(key.name);  // N æ¬¡æŸ¥è©¢
  if (JSON.parse(link).userId === targetUserId) {
    // æ‰¾åˆ°äº†
  }
}

// å¦‚æœæœ‰ 10,000 å€‹é€£çµ = 10,000 æ¬¡ KV è®€å–
// æˆæœ¬é«˜ã€é€Ÿåº¦æ…¢ã€ä¸å¯¦éš›ï¼
```

**çµè«–**: åˆ—è¡¨æŸ¥è©¢å¿…é ˆç”¨ D1 âœ…

---

#### **å ´æ™¯ 3: Admin æŸ¥çœ‹æ‰€æœ‰é€£çµ** ğŸ”

**éœ€æ±‚**: ç®¡ç†å“¡æŸ¥çœ‹ç³»çµ±ä¸­æ‰€æœ‰é€£çµ

**æ–¹æ¡ˆ A: åªç”¨ D1**
```sql
SELECT slug, url, user_id, title FROM links
```
- âœ… æŸ¥è©¢ç°¡å–®
- âŒ ä½†æ²’æœ‰ isActive, flagReason ç­‰ç‹€æ…‹ï¼ˆé€™äº›åœ¨ KVï¼‰
- âŒ éœ€è¦å†æŸ¥ KV ç²å–å®Œæ•´ç‹€æ…‹

**æ–¹æ¡ˆ B: åªç”¨ KV**ï¼ˆæˆ‘å‰›å‰›çš„å¯¦ç¾ï¼‰
```typescript
const list = await env.LINKS.list({ prefix: 'link:' });
const links = await Promise.all(
  list.keys.map(k => env.LINKS.get(k.name))
);
```
- âœ… æœ‰å®Œæ•´æ•¸æ“š
- âŒ æ²’æœ‰ user_emailï¼ˆéœ€è¦ JOIN users è¡¨ï¼‰
- âŒ éœ€è¦æŸ¥ D1 ç²å– users

**æ–¹æ¡ˆ C: KV + D1 æ··åˆ**ï¼ˆæ­£ç¢ºï¼‰
```typescript
// 1. D1 ç²å–åˆ—è¡¨ + user_email
SELECT l.slug, u.email FROM links l JOIN users u ON l.user_id = u.id

// 2. æ‰¹é‡å¾ KV ç²å–å®Œæ•´æ•¸æ“š
const fullData = await Promise.all(slugs.map(s => KV.get(s)))
```

**çµè«–**: æ··åˆæŸ¥è©¢æ˜¯å¿…è¦çš„ âœ…

---

## ğŸ’¡ é›™å¯«çš„çœŸæ­£åŸå› 

### **ä¸æ˜¯å†—ä½™ï¼Œæ˜¯ã€Œå„å–æ‰€é•·ã€**

```
KV çš„å„ªå‹¢ï¼š
â”œâ”€ æ¥µå¿«çš„é»æŸ¥è©¢ï¼ˆé‡å®šå‘ï¼‰
â”œâ”€ å®Œæ•´çš„æ•¸æ“šå„²å­˜
â””â”€ å…¨çƒé‚Šç·£åˆ†ä½ˆ

D1 çš„å„ªå‹¢ï¼š
â”œâ”€ è¤‡é›œçš„ SQL æŸ¥è©¢
â”œâ”€ JOIN å¤šè¡¨é—œè¯
â””â”€ WHERE æ¢ä»¶éæ¿¾

å…©è€…äº’è£œï¼Œç¼ºä¸€ä¸å¯ï¼
```

---

## âš ï¸ é›™å¯«çš„é¢¨éšªèˆ‡å°ç­–

### **é¢¨éšª 1: æ•¸æ“šä¸ä¸€è‡´**

**å•é¡Œå ´æ™¯**ï¼š
```typescript
// å¯«å…¥ KV æˆåŠŸ
await env.LINKS.put(...);  // âœ…

// å¯«å…¥ D1 å¤±æ•—
await env.DB.prepare(...).run();  // âŒ ç¶²è·¯éŒ¯èª¤

// çµæœï¼šKV æœ‰ï¼ŒD1 æ²’æœ‰ â†’ ä¸ä¸€è‡´
```

**å½±éŸ¿åˆ†æ**ï¼š

| æƒ…æ³ | KV ç‹€æ…‹ | D1 ç‹€æ…‹ | ç”¨æˆ¶å½±éŸ¿ | åš´é‡æ€§ |
|------|---------|---------|---------|--------|
| å‰µå»ºæ™‚ D1 å¤±æ•— | âœ… æœ‰ | âŒ ç„¡ | é‡å®šå‘æ­£å¸¸ï¼Œåˆ—è¡¨å°‘ä¸€ç­† | ğŸŸ¡ ä¸­ç­‰ |
| æ›´æ–°æ™‚ D1 å¤±æ•— | âœ… æ–° | âŒ èˆŠ | é‡å®šå‘æ­£å¸¸ï¼Œåˆ—è¡¨è³‡è¨Šéæ™‚ | ğŸŸ¢ è¼•å¾® |
| åˆªé™¤æ™‚ D1 å¤±æ•— | âŒ ç„¡ | âœ… æœ‰ | 404 éŒ¯èª¤ï¼Œåˆ—è¡¨å¤šä¸€ç­† | ğŸŸ¢ è¼•å¾® |

**é—œéµç™¼ç¾**: **KV æ˜¯ä¸»è¦ä¾†æºï¼ŒD1 å¤±æ•—ä¸æœƒå½±éŸ¿æ ¸å¿ƒåŠŸèƒ½**

---

### **æ¥­ç•Œæ¨™æº–åšæ³•**

#### **1. æœ€çµ‚ä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰**

**ç­–ç•¥**: å…è¨±çŸ­æš«ä¸ä¸€è‡´ï¼Œå¾Œå°è‡ªå‹•ä¿®å¾©

```typescript
// å¯«å…¥ KVï¼ˆå¿…é ˆæˆåŠŸï¼‰
await env.LINKS.put(`link:${slug}`, JSON.stringify(linkData));

// èƒŒæ™¯åŒæ­¥ D1ï¼ˆå¤±æ•—ä¸å½±éŸ¿ï¼‰
c.executionCtx.waitUntil(
  env.DB.prepare('INSERT INTO links ...').run()
    .catch(err => {
      console.error('D1 sync failed, will retry:', err);
      // è¨˜éŒ„åˆ°å¤±æ•—éšŠåˆ—ï¼Œå¾ŒçºŒé‡è©¦
    })
);

// ç«‹å³è¿”å›æˆåŠŸ
return c.json({ success: true, ... });
```

**å„ªé»**ï¼š
- âœ… ç”¨æˆ¶é«”é©—å¥½ï¼ˆä¸ç­‰ D1ï¼‰
- âœ… KV æ•¸æ“šçµ•å°å®‰å…¨
- âœ… D1 å¤±æ•—ä¸å½±éŸ¿

**ç¼ºé»**ï¼š
- âš ï¸ åˆ—è¡¨æŸ¥è©¢å¯èƒ½æš«æ™‚ç¼ºå°‘æ–°é€£çµ
- âš ï¸ éœ€è¦å¤±æ•—é‡è©¦æ©Ÿåˆ¶

---

#### **2. åŒæ­¥å¯«å…¥ + é™ç´šç­–ç•¥ï¼ˆç›®å‰çš„åšæ³•ï¼‰**

**ç­–ç•¥**: åŒæ™‚å¯«å…¥ï¼Œä½† D1 å¤±æ•—æ™‚é™ç´š

```typescript
// å¯«å…¥ KV
await env.LINKS.put(...);

try {
  // å˜—è©¦å¯«å…¥ D1
  await env.DB.prepare(...).run();
} catch (error) {
  // D1 å¤±æ•—ï¼Œè¨˜éŒ„ä½†ä¸å½±éŸ¿å›æ‡‰
  console.error('D1 sync failed:', error);
  // å¯ä»¥è¨˜éŒ„åˆ°ç›£æ§ç³»çµ±
}

// è¿”å›æˆåŠŸï¼ˆKV å·²å¯«å…¥ï¼‰
return c.json({ success: true });
```

**å„ªé»**ï¼š
- âœ… KV å’Œ D1 é€šå¸¸éƒ½æˆåŠŸï¼ˆ99.9%ï¼‰
- âœ… D1 å¤±æ•—ä¸é˜»å¡ç”¨æˆ¶

**ç¼ºé»**ï¼š
- âš ï¸ æ²’æœ‰è‡ªå‹•é‡è©¦
- âš ï¸ éœ€è¦å®šæœŸæª¢æŸ¥ä¸€è‡´æ€§

---

#### **3. å®šæœŸåŒæ­¥ä¿®å¾©ï¼ˆå»ºè­°æ·»åŠ ï¼‰**

**ç­–ç•¥**: æ¯å¤©æƒæ KVï¼Œè£œé½Š D1 ç¼ºå¤±çš„è¨˜éŒ„

```typescript
// Cron Trigger: æ¯å¤©å‡Œæ™¨ 3:00
export default {
  async scheduled(event, env, ctx) {
    // 1. æƒæ KV æ‰€æœ‰é€£çµ
    const kvLinks = await env.LINKS.list({ prefix: 'link:' });
    
    // 2. æŸ¥è©¢ D1 å·²æœ‰çš„ slugs
    const d1Slugs = await env.DB.prepare(
      'SELECT slug FROM links'
    ).all();
    const d1Set = new Set(d1Slugs.results.map(r => r.slug));
    
    // 3. æ‰¾å‡ºç¼ºå¤±çš„
    const missing = kvLinks.keys.filter(k => {
      const slug = k.name.replace('link:', '');
      return !d1Set.has(slug);
    });
    
    // 4. è£œé½Šåˆ° D1
    for (const key of missing) {
      const data = JSON.parse(await env.LINKS.get(key.name));
      await env.DB.prepare(
        'INSERT INTO links (slug, url, user_id, title, created_at) VALUES (?, ?, ?, ?, ?)'
      ).bind(data.slug, data.url, data.userId, data.title, data.createdAt).run();
    }
    
    console.log(`Synced ${missing.length} missing links to D1`);
  }
};
```

**å„ªé»**ï¼š
- âœ… è‡ªå‹•ä¿®å¾©ä¸ä¸€è‡´
- âœ… ä¸å½±éŸ¿æ­£å¸¸æ¥­å‹™
- âœ… ç°¡å–®å¯é 

---

## ğŸ¯ æœ€çµ‚å»ºè­°æ–¹æ¡ˆ

### **Phase 1: ç•¶å‰å¯¦ç¾ï¼ˆå·²å®Œæˆï¼‰**

**å‰µå»ºæ™‚**ï¼š
```typescript
// åŒæ­¥é›™å¯«ï¼ˆç°¡å–®å¯é ï¼‰
await env.LINKS.put(...);
await env.DB.prepare(...).run();
```

**æ›´æ–°æ™‚**ï¼š
```typescript
// åŒæ­¥é›™å¯«ï¼ˆå·²ä¿®å¾©ï¼‰
await env.LINKS.put(...);
await env.DB.prepare('UPDATE links ...').run();
```

**åˆªé™¤æ™‚**ï¼š
```typescript
// åŒæ­¥é›™åˆª
await env.LINKS.delete(...);
await env.DB.prepare('DELETE FROM links ...').run();
```

---

### **Phase 2: å„ªåŒ–ï¼ˆå»ºè­°å¯¦ç¾ï¼‰**

**æ”¹ç‚ºç•°æ­¥åŒæ­¥**ï¼š
```typescript
// å‰µå»ºé€£çµ
await env.LINKS.put(...);  // ä¸»è¦

c.executionCtx.waitUntil(
  syncToD1(env, linkData)  // èƒŒæ™¯åŒæ­¥
);

return c.json({ success: true });  // ç«‹å³è¿”å›
```

**æ·»åŠ å®šæœŸä¿®å¾©**ï¼š
```typescript
// æ¯å¤©è‡ªå‹•æƒæä¸¦ä¿®å¾©
scheduled: "0 3 * * *"  // æ¯å¤©å‡Œæ™¨ 3:00
```

---

## ğŸ“‹ è™•ç†ä¸ä¸€è‡´çš„å®Œæ•´ç­–ç•¥

### **æª¢æ¸¬ä¸ä¸€è‡´**

```bash
# æ‰‹å‹•æª¢æŸ¥è…³æœ¬
node check-consistency.js

è¼¸å‡ºï¼š
KV total: 1,234 links
D1 total: 1,230 links
Missing in D1: 4 links
- link:abc123
- link:def456
- link:ghi789
- link:jkl012
```

### **ä¿®å¾©ä¸ä¸€è‡´**

```bash
# æ–¹æ¡ˆ A: å¾ KV åŒæ­¥åˆ° D1
node sync-kv-to-d1.js

# æ–¹æ¡ˆ B: ä½¿ç”¨ Cron Trigger è‡ªå‹•ä¿®å¾©
# ç„¡éœ€æ‰‹å‹•æ“ä½œ
```

---

## ğŸ“ æ¥­ç•Œå°æ¯”

### **æ¡ˆä¾‹ 1: Bitly**
- ä¸»æ•¸æ“šï¼šPostgreSQL
- å¿«å–ï¼šRedis
- ç­–ç•¥ï¼šWrite-through cache
- ä¸€è‡´æ€§ï¼šå¼·ä¸€è‡´æ€§ï¼ˆåŒæ­¥å¯«å…¥ï¼‰

### **æ¡ˆä¾‹ 2: Short.io**
- ä¸»æ•¸æ“šï¼šMongoDB
- å¿«å–ï¼šRedis
- ç­–ç•¥ï¼šCache-aside
- ä¸€è‡´æ€§ï¼šæœ€çµ‚ä¸€è‡´æ€§

### **æ¡ˆä¾‹ 3: Rebrandly**
- ä¸»æ•¸æ“šï¼šMySQL
- å¿«å–ï¼šRedis + CDN
- ç­–ç•¥ï¼šWrite-through + TTL
- ä¸€è‡´æ€§ï¼šå¼·ä¸€è‡´æ€§

### **æˆ‘å€‘çš„åšæ³•**ï¼š

```
ä¸»æ•¸æ“šï¼šKVï¼ˆå¿«é€Ÿã€é‚Šç·£åˆ†ä½ˆï¼‰
ç´¢å¼•ï¼šD1ï¼ˆè¤‡é›œæŸ¥è©¢ï¼‰
ç­–ç•¥ï¼šé›™å¯« + æœ€çµ‚ä¸€è‡´æ€§
ä¸€è‡´æ€§ï¼šåŒæ­¥å¯«å…¥ï¼ŒèƒŒæ™¯ä¿®å¾©
```

**èˆ‡æ¥­ç•Œå°æ¯”**ï¼š
- âœ… é¡ä¼¼ Cache-aside ä½†æ›´åš´è¬¹
- âœ… å…¼é¡§æ€§èƒ½èˆ‡æŸ¥è©¢èƒ½åŠ›
- âœ… Cloudflare æ¶æ§‹çš„æœ€ä½³å¯¦è¸

---

## âœ… æœ€çµ‚çµè«–

### **é›™å¯«æ˜¯å¦å¿…è¦ï¼Ÿ**

**ç­”æ¡ˆ**: **æ˜¯ï¼å®Œå…¨å¿…è¦ï¼**

**åŸå› **ï¼š
1. **KV ç„¡æ³•åšè¤‡é›œæŸ¥è©¢** - å¿…é ˆæœ‰ D1
2. **D1 å¤ªæ…¢ç„¡æ³•åšé‡å®šå‘** - å¿…é ˆæœ‰ KV
3. **å…©è€…åŠŸèƒ½ä¸é‡ç–Š** - ä¸æ˜¯å†—ä½™ï¼Œæ˜¯äº’è£œ

### **æ­£ç¢ºçš„æ¶æ§‹**ï¼š

```
Links æ•¸æ“šçš„è·è²¬åˆ†å·¥ï¼š

KV (ä¸»è¦ä¾†æº):
â”œâ”€ é‡å®šå‘ç”¨ï¼ˆCore Workerï¼‰
â”œâ”€ å®Œæ•´æ•¸æ“šï¼ˆtitle, image, isActive, ç­‰ï¼‰
â””â”€ çœŸå¯¦ä¾†æºï¼ˆSource of Truthï¼‰

D1 (ç´¢å¼•/æŸ¥è©¢):
â”œâ”€ ç”¨æˆ¶æŸ¥è©¢ï¼ˆWHERE user_id = ?ï¼‰
â”œâ”€ JOIN æ“ä½œï¼ˆèˆ‡ users è¡¨ï¼‰
â””â”€ åˆ—è¡¨åˆ†é ï¼ˆLIMIT OFFSETï¼‰

Analytics Engine (é»æ“Šè¿½è¹¤):
â””â”€ æ‰€æœ‰é»æ“Šäº‹ä»¶ï¼ˆå³æ™‚è¨ˆç®— clicksï¼‰
```

### **ä¸ä¸€è‡´çš„è™•ç†**ï¼š

**Phase 1** (ç•¶å‰):
- åŒæ­¥é›™å¯«
- æ‰‹å‹•ç›£æ§

**Phase 2** (å»ºè­°):
- ç•°æ­¥åŒæ­¥
- å®šæœŸè‡ªå‹•ä¿®å¾©ï¼ˆCron Triggerï¼‰
- ç›£æ§å‘Šè­¦

---

## ğŸ“Œ è¡Œå‹•å»ºè­°

### **ç«‹å³åŸ·è¡Œ**ï¼š
1. âœ… ä¿æŒé›™å¯«ç­–ç•¥ï¼ˆå·²å¯¦ç¾ï¼‰
2. âœ… ä¿®å¾©æ›´æ–°æ™‚çš„ D1 åŒæ­¥ï¼ˆå·²ä¿®å¾©ï¼‰
3. âœ… Admin API å¾ KV è®€å–ï¼ˆå·²å¯¦ç¾ï¼‰

### **æœªä¾†å„ªåŒ–**ï¼š
1. æ”¹ç‚ºç•°æ­¥åŒæ­¥ï¼ˆæå‡æ€§èƒ½ï¼‰
2. æ·»åŠ  Cron å®šæœŸä¿®å¾©
3. æ·»åŠ ä¸€è‡´æ€§ç›£æ§

---

**æ ¸å¿ƒåŸå‰‡**: KV æ˜¯ä¸»ï¼ŒD1 æ˜¯è¼”ã€‚å¯§å¯ D1 ä¸ä¸€è‡´ï¼Œä¸å¯ KV å‡ºéŒ¯ã€‚
